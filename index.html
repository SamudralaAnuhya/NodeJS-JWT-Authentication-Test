<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="title">Document</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.7/axios.min.js"
        integrity="sha512-NQfB/bDaB8kaSXF8E77JjhHG5PM6XVRxvHzkZiwl3ddWCEPBa23T76MuWSwAJdMGJnmQqM0VeY9kFszsrBEFrQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
    <div class="container-fluid">
        <h1 class="login">Login</h1>
        <main>
            <div class="row">
                <label for="username">Username</label>
                <input type="text" id="username" name="username"><br><br>

            </div>
            <div class="row">
                <label for="password">password</label>
                <input type="password" id="password" name="password"><br><br>
            </div>
            </br>
            </br>

            <div style="display: flex;">
                <button onclick="login()">Login</button>
                <button id='dashboard' onclick="getDashboard()">View Dashboard</button>
                <button id='settings' onclick="changeSettings()">Change Settings</button>
            </div>


        </main>


        <div>
            </br>
            <p id="button"></p>
        </div>

    </div>

    <script>
        var token = "";
        function login() {
            const data = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
            };
            axios.post('/api/login', data).then
                (res => {
                    console.log(res);
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                    if (res && res.data && res.data.success) {
                        localStorage.setItem('token', res.data.token);
                        // token = res.data.token;
                        getDashboard();
                    }
                });
        }

        function getDashboard() {
            const token = localStorage.getItem('token');
            axios.get('/api/dashboard', {
                headers: {
                    'Authorization': `Bearer ${token}`

                }
            }).then(res => {
                if (res && res.data && res.data.success) {
                    document.querySelector('h1.login').innerHTML = 'Welcome to your personalized Dashboard';
                    document.querySelector('main').innerHTML = res.data.myContent;
                    document.getElementById('title').innerText = "Dashboard";
                    var button = "<button type='button' onclick='logout()'>Logout</button><button type='button' onclick='changeSettings()'>Settings</button>";
                    document.getElementById('button').innerHTML = button;
                    history.pushState({}, '', '/dashboard');
                }
            }).catch(err => {
                if (err.response && err.response.status == 401) {
                    setTimeout(() => {
                        localStorage.removeItem('token');
                        window.location.href = '/';
                    }, 1000);

                }
            });
        }

        function changeSettings() {
            const token = localStorage.getItem('token');
            axios.get('/api/settings', {
                'Authorization': `Bearer ${token}`
            }).then(res => {
                if (res && res.data && res.data.success) {
                    document.querySelector('h1.login').innerHTML = 'Your Settings';
                    document.querySelector('main').innerHTML = res.data.myContent;
                    document.getElementById('title').innerText = "Settings";
                    history.pushState({}, '', '/settings');
                }

            }).catch(err => {
                if (err.response && err.response.status == 401) {
                    setTimeout(() => {
                        localStorage.removeItem('token');
                        window.location.href = '/';
                    }, 1000);
                }
            });
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }

        function onLoad() {
            const token = localStorage.getItem('token');
            if (token) {
                getDashboard();
            }
        }
        onLoad();
    </script>


</body>

</html>